---
title: "1-Reading in Data"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

# Overall Structure of the code
### Source
In this file, we read in the data from the [LAPOP Datasets](http://datasets.americasbarometer.org/database/index.php). In order to do this, you need to download them to your machine and place them in this file.

### Workflow
Suggested order to follow:
1. Reading in Data
2. Categories and Questions
3. Adding Wave Column
4. Creating Unique ID
5. Lengthening and Joining
6. Subsetting Categories

### Factored vs. Unfactored
The data in the Stata files are factored, meaning that a yes or no question would be entered in as 0 and 1. These numbers are then assigned labels as such: 0 - "yes" and 1 - "no", and we refer to data frames where the labels are visible in the observations as *factored*. When data frames use only the numbered observations, we refer to this as *unfactored*.

We use both versions of the data frames for ease of use in Tableau Public. Unfactored data frames allow us to perform calculations in Tableau Public later on, and the factored data frames provide reader-friendly text to the graphics.

## Libraries
These packages contain the functions that are necessary to run the code below. These can be installed using `install.packages()`, and then you should run the code chunk below so they are ready to be used.
```{r, message=FALSE}
library(labelled)
library(sjmisc)
library(tidyverse)
library(assertr)
library(haven)
```

The first function we wrote, `factor_country()`, reads the file in and edits the column name so that it ends in "_factor" to differentiate between unfactored and factored when we combine them later.

## Creating factored and unfactored dataframes
```{r}
factor_country <- function(country){
  #Reads file for the country
  country <- read_dta(country)
  #Factors all the columns
  country <- as_factor(country)
  
  #Starts list x
  x <- 1
  
  #Changes name of column to add "factor"
  while(x <= length(country)){
      colnames(country)[x] <- paste(colnames(country)[x], "factor", sep = "_")
     x <- x + 1
  }
  country
}
```

# Reading in merged country files
This is where we read in all the factored data. You should use the *most recent* merged country files for this section. The factored and unfactored file names are the same.

If you want to change the files that are being read in, you can either make a new code chunk or replace the current file names. If you do this, you have to make sure there is an unfactored version of the file as well.

## Creating factored dataframes using `factor_country`
```{r}
argentina_factor <- factor_country("data/1326054827Argentina LAPOP merge 2008-2014 v3.0_W_dta.zip")
bolivia_factor <- factor_country("data/1500779614Bolivia LAPOP merge 2004-2014 v3.0_W_dta.zip")
brazil_factor <- factor_country("data/1058457654Brazil LAPOP merge 2007-2014 v3.0_W_dta.zip") %>% 
  #Correcting for inconsistencies in spelling
  mutate(pais_factor = recode(pais_factor, Brasil = "Brazil"))
belize_factor <- factor_country("data/1866361808Belize LAPOP merge 2008-2014 v3.0_W_dta.zip")
canada_factor <- factor_country("data/257165704Canada LAPOP merge 2006-2014 v3.0_W_dta.zip") %>% 
  #Correcting for inconsistencies in accents
  mutate(pais_factor = recode(pais_factor, Canadá = "Canada"))
chile_factor <- factor_country("data/1651690880Chile LAPOP merge 2006-2014 v3.0_W_dta.zip")
colombia_factor <- factor_country("data/26761406Colombia LAPOP merge 2004-2014 v3.0_W_dta.zip")
costa_factor <- factor_country("data/312640706CostaRica LAPOP merge 2004-2014 v3.0_W_dta.zip")
ecuador_factor <- factor_country("data/1562314955Ecuador LAPOP merge 2004-2014 v3.0_W_dta.zip")
elsalvador_factor <- factor_country("data/71618678ElSalvador LAPOP merge 2004-2014 v3.0_W_dta.zip")
guatemala_factor <- factor_country("data/833541857Guatemala LAPOP merge 2004-2014 v3.0_W_dta.zip")
guyana_factor <- factor_country("data/1293237393Guyana LAPOP merge 2006-2014 v3.0_W_dta.zip")
honduras_factor <- factor_country("data/125162980Honduras LAPOP merge 2004-2014 v3.0_W_dta.zip")
jamaica_factor <- factor_country("data/1518553693Jamaica LAPOP merge 2006-2014 v3.0_W_dta.zip")
mexico_factor <- factor_country("data/1467358429Mexico LAPOP merge 2004-2014 v3.0_W_dta.zip") %>% 
  #Correcting for inconsistencies in accents
  mutate(pais_factor = recode(pais_factor, México = "Mexico"))
nicaragua_factor <- factor_country("data/420919900Nicaragua LAPOP merge 2004-2014 v3.0_W_dta.zip")
panama_factor <- factor_country("data/1909860951Panama LAPOP merge 2004-2014 v3.0_W_dta.zip") %>% 
  #Correcting for inconsistencies in accents
  mutate(pais_factor = recode(pais_factor, Panamá = "Panama"))
paraguay_factor <- factor_country("data/450650714Paraguay LAPOP merge 2006-2014 v3.0_W_dta.zip")
peru_factor <- factor_country("data/897206140Peru LAPOP merge 2006-2014 v3.0_W_dta.zip") %>% 
  #Correcting for inconsistencies in accents
  mutate(pais_factor = recode(pais_factor, Perú = "Peru"))
suriname_factor <- factor_country("data/2028239474Suriname LAPOP merge 2010-2014 v3.0_W_dta.zip")
usa_factor <- factor_country("data/1355754260UnitedStates LAPOP merge 2006-2014 v3.0_W_dta.zip") %>% 
  #Correcting for inconsistencies in spelling
  mutate(pais_factor = recode(pais_factor, "Estados Unidos" = "United States"))
uruguay_factor <- factor_country("data/1222977998Uruguay LAPOP merge 2007-2014 v3.0_W_dta.zip")
venezuela_factor <- factor_country("data/1165310382Venezuela LAPOP merge 2007-2014 v3.0_W_dta.zip")
```

## Creating unfactored dataframes using `read_dta`
This is where we read in the unfactored data.
```{r}
argentina_unfactor <- read_dta("data/1326054827Argentina LAPOP merge 2008-2014 v3.0_W_dta.zip")
bolivia_unfactor <- read_dta("data/1500779614Bolivia LAPOP merge 2004-2014 v3.0_W_dta.zip")
brazil_unfactor <- read_dta("data/1058457654Brazil LAPOP merge 2007-2014 v3.0_W_dta.zip")
belize_unfactor <- read_dta("data/1866361808Belize LAPOP merge 2008-2014 v3.0_W_dta.zip")
canada_unfactor <- read_dta("data/257165704Canada LAPOP merge 2006-2014 v3.0_W_dta.zip")
chile_unfactor <- read_dta("data/1651690880Chile LAPOP merge 2006-2014 v3.0_W_dta.zip")
colombia_unfactor <- read_dta("data/26761406Colombia LAPOP merge 2004-2014 v3.0_W_dta.zip")
costa_unfactor <- read_dta("data/312640706CostaRica LAPOP merge 2004-2014 v3.0_W_dta.zip")
ecuador_unfactor <- read_dta("data/1562314955Ecuador LAPOP merge 2004-2014 v3.0_W_dta.zip")
elsalvador_unfactor <- read_dta("data/71618678ElSalvador LAPOP merge 2004-2014 v3.0_W_dta.zip")
guatemala_unfactor <- read_dta("data/833541857Guatemala LAPOP merge 2004-2014 v3.0_W_dta.zip")
guyana_unfactor <- read_dta("data/1293237393Guyana LAPOP merge 2006-2014 v3.0_W_dta.zip")
honduras_unfactor <- read_dta("data/125162980Honduras LAPOP merge 2004-2014 v3.0_W_dta.zip")
jamaica_unfactor <- read_dta("data/1518553693Jamaica LAPOP merge 2006-2014 v3.0_W_dta.zip")
mexico_unfactor <- read_dta("data/1467358429Mexico LAPOP merge 2004-2014 v3.0_W_dta.zip")
nicaragua_unfactor <- read_dta("data/420919900Nicaragua LAPOP merge 2004-2014 v3.0_W_dta.zip")
panama_unfactor <- read_dta("data/1909860951Panama LAPOP merge 2004-2014 v3.0_W_dta.zip")
paraguay_unfactor <- read_dta("data/450650714Paraguay LAPOP merge 2006-2014 v3.0_W_dta.zip")
peru_unfactor <- read_dta("data/897206140Peru LAPOP merge 2006-2014 v3.0_W_dta.zip")
suriname_unfactor <- read_dta("data/2028239474Suriname LAPOP merge 2010-2014 v3.0_W_dta.zip")
usa_unfactor <- read_dta("data/1355754260UnitedStates LAPOP merge 2006-2014 v3.0_W_dta.zip")
uruguay_unfactor <- read_dta("data/1222977998Uruguay LAPOP merge 2007-2014 v3.0_W_dta.zip")
venezuela_unfactor <- read_dta("data/1165310382Venezuela LAPOP merge 2007-2014 v3.0_W_dta.zip")
```



# Reading in 2016/17 files
Because there is no pre-existing merge that include 2016/17 data, we are reading it in separately and then joining it later in the process.

If you are using the new merged files, you can skip this.

## Creating factored dataframes of 2016/17 questionnaires using `factor_country`
This is the 16/17 version of the `factor_country()` used above. The same process applies, but we have renamed the `uniq_id` column to `person_id` for clarification.
```{r}
factor16_country <- function(country){
  #Reads file for the country
  country <- read_dta(country)
  #Factors all the columns
  country <- as_factor(country) %>% 
    rename(person_id = uniq_id)
  
  #Starts list x
  x <- 1
  
  #Changes name of column to add "factor"
  while(x <= length(country)){
      colnames(country)[x] <- paste(colnames(country)[x], "factor", sep = "_")
     x <- x + 1
  }
  country
}
```

```{r}
argentina_16_factor <- factor16_country("data/42076439Argentina LAPOP AmericasBarometer 2017 V1.0_W.dta")
bolivia_16_factor  <- factor16_country("data/142790203Bolivia LAPOP AmericasBarometer 2017 V1.0_W.dta")
brazil_16_factor  <- factor16_country("data/780314464Brazil LAPOP AmericasBarometer 2017 V1.0_W.dta") %>% 
  mutate(pais_factor = recode(pais_factor, Brasil = "Brazil"))
canada_16_factor  <- factor16_country("data/576555173Canada LAPOP AmericasBarometer 2017 V1.0_W.dta")
chile_16_factor  <- factor16_country("data/336280178Chile LAPOP AmericasBarometer 2017 V1.0_W.dta")
colombia_16_factor  <- factor16_country("data/1966987763Colombia LAPOP AmericasBarometer 2016 V1.0_W.dta")
costa_16_factor  <- factor16_country("data/1636511905CostaRica LAPOP AmericasBarometer 2016 V1.0_W.dta")
ecuador_16_factor  <- factor16_country("data/1061044693Ecuador LAPOP AmericasBarometer 2016-17 V1.0_W.dta")
elsalvador_16_factor  <- factor16_country("data/381267663ElSalvador LAPOP AmericasBarometer 2016 V1.0_W.dta")
guatemala_16_factor  <- factor16_country("data/823416394Guatemala LAPOP AmericasBarometer 2017 V1.0_W.dta")
guyana_16_factor  <- factor16_country("data/1740874324Guyana LAPOP AmericasBarometer 2016 V1.0_W.dta")
honduras_16_factor  <- factor16_country("data/1252173714Honduras LAPOP AmericasBarometer 2016 V1.0_W.dta")
jamaica_16_factor  <- factor16_country("data/428805428Jamaica LAPOP AmericasBarometer 2017 V1.0_W.dta")
mexico_16_factor  <- factor16_country("data/275973272Mexico LAPOP AmericasBarometer 2017 V1.0_W.dta") %>% 
  mutate(pais_factor = recode(pais_factor, México = "Mexico"))
nicaragua_16_factor  <- factor16_country("data/1862548546Nicaragua LAPOP AmericasBarometer 2016 V1.0_W.dta")
panama_16_factor  <- factor16_country("data/2078678947Panama LAPOP AmericasBarometer 2017 V1.0_W.dta") %>% 
  mutate(pais_factor = recode(pais_factor, Panamá = "Panama"))
paraguay_16_factor <- factor16_country("data/1311870907Paraguay LAPOP AmericasBarometer 2016 V1.0 W.dta")
peru_16_factor  <- factor16_country("data/83639715Peru_LAPOP_AmericasBarometer_2017_V1.1_W.dta") %>% 
  mutate(pais_factor = recode(pais_factor, Perú = "Peru"))
usa_16_factor  <- factor16_country("data/2133069031United States LAPOP AmericasBarometer 2017 V1.0_W.dta") %>% 
  #Correcting for inconsistencies in spelling
  mutate(pais_factor = recode(pais_factor, "Estados Unidos" = "United States"))
uruguay_16_factor  <- factor16_country("data/646644681Uruguay LAPOP AmericasBarometer 2017 V1.0_W.dta")
venezuela_16_factor  <- factor16_country("data/25258094Venezuela LAPOP AmericasBarometer 2016-17 V1.0_W.dta")
```


## Creating unfactored dataframes of 2016/17 questionnaires using `read_dta`
This is the unfactored version of the 16/17 data frames, but we needed to apply modifications for when we eventually combined the 16/17 with the merged. 
We renamed the unique ID column to `person_id` and transformed it to a character. This does not affect the data, but is necessary for the join.
```{r}
argentina_16_unfactor <- read_dta("data/42076439Argentina LAPOP AmericasBarometer 2017 V1.0_W.dta") %>%
  rename(person_id = uniq_id) %>% 
  transform(person_id = as.character(person_id))

bolivia_16_unfactor  <- read_dta("data/142790203Bolivia LAPOP AmericasBarometer 2017 V1.0_W.dta") %>% 
  rename(person_id = uniq_id) %>% 
  transform(person_id = as.character(person_id))

brazil_16_unfactor  <- read_dta("data/780314464Brazil LAPOP AmericasBarometer 2017 V1.0_W.dta") %>% 
  rename(person_id = uniq_id) %>% 
  transform(person_id = as.character(person_id))

canada_16_unfactor  <- read_dta("data/576555173Canada LAPOP AmericasBarometer 2017 V1.0_W.dta") %>% 
  rename(person_id = uniq_id) %>% 
  transform(person_id = as.character(person_id))

chile_16_unfactor  <- read_dta("data/336280178Chile LAPOP AmericasBarometer 2017 V1.0_W.dta") %>% 
  rename(person_id = uniq_id) %>% 
  transform(person_id = as.character(person_id))

colombia_16_unfactor  <- read_dta("data/1966987763Colombia LAPOP AmericasBarometer 2016 V1.0_W.dta") %>% 
  rename(person_id = uniq_id) %>% 
  transform(person_id = as.character(person_id))

costa_16_unfactor  <- read_dta("data/1636511905CostaRica LAPOP AmericasBarometer 2016 V1.0_W.dta") %>% 
  rename(person_id = uniq_id) %>% 
  transform(person_id = as.character(person_id))

ecuador_16_unfactor  <- read_dta("data/1061044693Ecuador LAPOP AmericasBarometer 2016-17 V1.0_W.dta") %>% 
  rename(person_id = uniq_id) %>% 
  transform(person_id = as.character(person_id))

elsalvador_16_unfactor  <- read_dta("data/381267663ElSalvador LAPOP AmericasBarometer 2016 V1.0_W.dta") %>% 
  rename(person_id = uniq_id) %>% 
  transform(person_id = as.character(person_id))

guatemala_16_unfactor  <- read_dta("data/823416394Guatemala LAPOP AmericasBarometer 2017 V1.0_W.dta") %>%
  rename(person_id = uniq_id) %>% 
  transform(person_id = as.character(person_id))

guyana_16_unfactor  <- read_dta("data/1740874324Guyana LAPOP AmericasBarometer 2016 V1.0_W.dta") %>% 
  rename(person_id = uniq_id) %>% 
  transform(person_id = as.character(person_id))

honduras_16_unfactor  <- read_dta("data/1252173714Honduras LAPOP AmericasBarometer 2016 V1.0_W.dta") %>% 
  rename(person_id = uniq_id) %>% 
  transform(person_id = as.character(person_id))

jamaica_16_unfactor  <- read_dta("data/428805428Jamaica LAPOP AmericasBarometer 2017 V1.0_W.dta") %>% 
  rename(person_id = uniq_id) %>% 
  transform(person_id = as.character(person_id))

mexico_16_unfactor  <- read_dta("data/275973272Mexico LAPOP AmericasBarometer 2017 V1.0_W.dta") %>% 
  rename(person_id = uniq_id) %>% 
  transform(person_id = as.character(person_id))

nicaragua_16_unfactor  <- read_dta("data/1862548546Nicaragua LAPOP AmericasBarometer 2016 V1.0_W.dta") %>% 
  rename(person_id = uniq_id) %>% 
  transform(person_id = as.character(person_id))

panama_16_unfactor  <- read_dta("data/2078678947Panama LAPOP AmericasBarometer 2017 V1.0_W.dta") %>% 
  rename(person_id = uniq_id) %>% 
  transform(person_id = as.character(person_id))

paraguay_16_unfactor <- read_dta("data/1311870907Paraguay LAPOP AmericasBarometer 2016 V1.0 W.dta") %>% 
  rename(person_id = uniq_id) %>% 
  transform(person_id = as.character(person_id))

peru_16_unfactor  <- read_dta("data/83639715Peru_LAPOP_AmericasBarometer_2017_V1.1_W.dta") %>% 
  rename(person_id = uniq_id) %>% 
  transform(person_id = as.character(person_id))

usa_16_unfactor  <- read_dta("data/2133069031United States LAPOP AmericasBarometer 2017 V1.0_W.dta") %>% 
  rename(person_id = uniq_id) %>% 
  transform(person_id = as.character(person_id))

uruguay_16_unfactor  <- read_dta("data/646644681Uruguay LAPOP AmericasBarometer 2017 V1.0_W.dta") %>% 
  rename(person_id = uniq_id) %>% 
  transform(person_id = as.character(person_id))

venezuela_16_unfactor  <- read_dta("data/25258094Venezuela LAPOP AmericasBarometer 2016-17 V1.0_W.dta") %>% 
  rename(person_id = uniq_id) %>% 
  transform(person_id = as.character(person_id))
```
