---
title: "Widening for Tableau Public"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

# Structure

Now that we finally have a single dataframe with all the countries with only the common questions, we need to widen it so that it fits within Tableau Public's limit.

In order to do this we are going to:

* combine columns into the format of "category:question text"
* select the necessary columns (country, wave, person_id, weight, category_question, answer_measure)

```{r}
library(assertr)
```

## Combining category and question
```{r}
countries_common_only <- countries_common_only %>% 
  unite(category_question, category, question, sep = ":")
```

## Pivoting Wider (!Runs error because answer_measure not uniquely identified)
```{r}
countries_common_only <- countries_common_only %>% 
  select(country, wave, person_id_factor, weights, category_question, answer_measure) %>% 
  pivot_wider(names_from = category_question, values_from = answer_measure)
```

Ran into error saying that values are not uniquely identified. Going to try to identify duplicates. 
Check "Testing Wide Unique ID.Rmd" for results
```{r}
test0 <- countries_common_only %>% 
  select(country, wave, person_id_factor, weights, category_question, answer_measure) %>% 
  filter(country == c("Argentina", "Bolivia")) %>% 
  pivot_wider(names_from = category_question, values_from = answer_measure)
```

```{r}
test0 <- countries_common_only %>% 
  select(country, wave, person_id_factor, weights, category_question, answer_measure) %>% 
  filter(country ==  "Guyana") %>% 
  pivot_wider(names_from = category_question, values_from = answer_measure)
```

## Pivoting countries that have confirmed unique IDs
```{r}
wide_confirmed_countries <- countries_common_only %>% 
  select(country, wave, person_id_factor, weights, category_question, answer_measure) %>% 
  filter(country == c("Argentina", "Belize", "Brazil", "Chile", "Guyana", "Nicaragua", "Panama", "Paraguay", "Peru", "Suriname", "United States", "Uruguay", "Venezuela")) %>% 
  pivot_wider(names_from = category_question, values_from = answer_measure)

wide_confirmed_countries
```

Above thew an error that "longer object length is not a multiple of shorter length" so I'm going to try to find where that is.

## Testing different combinations of countries
```{r}
combo_1 <- countries_common_only %>% 
  select(country, wave, person_id_factor, weights, category_question, answer_measure) %>% 
  filter(country == c("Argentina", "Belize")) %>% 
  pivot_wider(names_from = category_question, values_from = answer_measure)
         
combo_1 #Throws length error but produces some values
```

```{r}
combo_2 <- countries_common_only %>% 
  select(country, wave, person_id_factor, weights, category_question, answer_measure) %>% 
  filter(country == c("Argentina", "Belize", "Brazil")) %>% 
  pivot_wider(names_from = category_question, values_from = answer_measure)
         
combo_2 #No error thrown but more missing values
```

```{r}
combo_3 <- countries_common_only %>% 
  select(country, wave, person_id_factor, weights, category_question, answer_measure) %>% 
  filter(country == c("Argentina", "Belize", "Brazil", "Chile")) %>% 
  pivot_wider(names_from = category_question, values_from = answer_measure)
         
combo_3 #Throws length error but produces a lot more values
```


Going to try adding in a row number
```{r}
test1 <- countries_common_only %>% 
  select(country, wave, person_id_factor, weights, category_question, answer_measure) %>% 
  mutate(row_num = row_number()) %>% 
  filter(country == c("Argentina", "Bolivia")) %>% 
  pivot_wider(names_from = category_question, values_from = answer_measure)
```

Error occurs again here going to look into other arguments in `pivot_wider()`
```{r}
test2 <- countries_common_only %>% 
  select(country, wave, person_id_factor, weights, category_question, answer_measure) %>% 
  filter(country == c("Argentina", "Bolivia")) %>% 
  pivot_wider(names_from = category_question, names_repair = "unique", values_from = answer_measure)
```

## Searching for duplicates
```{r}
countries_common_only %>% 
  assert(is_uniq, person_id_factor)
```




